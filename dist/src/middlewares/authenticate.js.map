{"version":3,"sources":["../../../src/middlewares/authenticate.ts"],"sourcesContent":["import jwt, { JwtPayload } from \"jsonwebtoken\";\nimport prisma from \"@/models/prisma\";\nimport { NextFunction, Response, Request } from \"express\";\nimport createError from \"@/utils/create-error\";\n\ninterface IPayload extends JwtPayload {\n\tid: string;\n\tid_passpost: string;\n\tfirstname: string;\n\tlastname: string;\n\trole: \"OWNER\" | \"CUSTOMER\";\n}\n\nconst authMiddleware = async (\n\treq: Request,\n\tres: Response,\n\tnext: NextFunction\n) => {\n\ttry {\n\t\tconst authorization = req.headers.authorization;\n\t\tif (!authorization) {\n\t\t\treturn next(createError(\"unauthenticated\", 401));\n\t\t}\n\n\t\tconst token = authorization.split(\" \")[1];\n\n\t\tconst payload = jwt.verify(\n\t\t\ttoken,\n\t\t\tprocess.env.JWT_SECRET_KEY || \"secretKeyRandom\"\n\t\t) as IPayload;\n\n\t\t// const { id_passpost } = payload;\n\n\t\tconst user = await prisma.user.findUnique({\n\t\t\twhere: {\n\t\t\t\tid: payload.id,\n\t\t\t},\n\t\t});\n\n\t\tif (!user) {\n\t\t\treturn next(createError(\"unauthenticated\", 401));\n\t\t}\n\n\t\tdelete user.password;\n\n\t\treq.user = user;\n\t\tnext();\n\t} catch (error) {\n\t\tif (error.name === \"TokenExpiredError\" || \"JsonWebTokenError\") {\n\t\t\terror.statusCode = 401;\n\t\t}\n\t\tnext(error);\n\t}\n};\n\nexport default authMiddleware;\n"],"names":["authMiddleware","req","res","next","authorization","headers","createError","token","split","payload","jwt","verify","process","env","JWT_SECRET_KEY","user","prisma","findUnique","where","id","password","error","name","statusCode"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAuDA;;;eAAA;;;uDAvDgC;iDACb;sDAEK;;;;;;AAUxB,MAAMA,iBAAiB,OACtBC,KACAC,KACAC;IAEA,IAAI;QACH,MAAMC,gBAAgBH,IAAII,OAAO,CAACD,aAAa;QAC/C,IAAI,CAACA,eAAe;YACnB,OAAOD,KAAKG,IAAAA,oBAAW,EAAC,mBAAmB;QAC5C;QAEA,MAAMC,QAAQH,cAAcI,KAAK,CAAC,IAAI,CAAC,EAAE;QAEzC,MAAMC,UAAUC,qBAAG,CAACC,MAAM,CACzBJ,OACAK,QAAQC,GAAG,CAACC,cAAc,IAAI;QAK/B,MAAMC,OAAO,MAAMC,eAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YACzCC,OAAO;gBACNC,IAAIV,QAAQU,EAAE;YACf;QACD;QAEA,IAAI,CAACJ,MAAM;YACV,OAAOZ,KAAKG,IAAAA,oBAAW,EAAC,mBAAmB;QAC5C;QAEA,OAAOS,KAAKK,QAAQ;QAEpBnB,IAAIc,IAAI,GAAGA;QACXZ;IACD,EAAE,OAAOkB,OAAO;QACf,IAAIA,MAAMC,IAAI,KAAK,uBAAuB,qBAAqB;YAC9DD,MAAME,UAAU,GAAG;QACpB;QACApB,KAAKkB;IACN;AACD;MAEA,WAAerB"}